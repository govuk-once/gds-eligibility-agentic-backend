## Terraform Deployment

1. `cd terraform`
2. `aws-vault exec <AWS_PROFILE> -- terraform init -backend-config=./dev.s3.tfbackend -reconfigure`
3. `aws-vault exec <AWS_PROFILE> -- terraform workspace select <ENV>`
    - `<ENV>` should be `goe-dev` or `goe-staging`
4. `aws-vault exec <AWS_PROFILE> -- terraform plan`
5. `aws-vault exec <AWS_PROFILE> -- terraform apply`

## Local development
1. `aws-vault exec <AWS_PROFILE> -- docker-compose up`

## Setting up Knowledge Base

There is currently an issue with the [aws_bedrockagent_knowledge_base](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/bedrockagent_knowledge_base#serverless_configuration-block) Terraform resource, whereby the Redshift query engine will not attach to the Knowledge Base when provisioned via Terraform.

After applying the Terraform, the Knowledge Base must be created and configured manually in the AWS Console.

Follow the steps below in the appropriate environment.

### Populate Redshift SQL database with test data
1. Go to <b>Redshift Serverless dashboard</b> -> <b>Query data</b> -> <b>Query in query editor v2</b>
2. Connect to `Serverless: bedrock-kb` workgroup, database name `eligibility`. Use Secrets Manager to connect: username is `adminuser` - use the (autogenerated) secret assigned to this user.
3. Run a query to insert some test data into the database, for example:
```
CREATE TABLE IF NOT EXISTS eligibility_results (
      user_id VARCHAR(50),
      benefit VARCHAR(100),
      eligible BOOLEAN
    );
    
INSERT INTO eligibility_results (user_id, benefit, eligible)
    VALUES ('test-user-123', 'free_school_meals', true);
```

### Create Knowledge Base
4. Go to <b>Amazon Bedrock</b> -> <b>Knowledge Bases</b>
5. Click <b>Create</b> -> <b>Structured data store</b>
6. Provide Knowledge Base details:
    - Name: choose an appropriate name
    - IAM permissions: select <b>Use an existing service role</b> and choose `bedrock-knowledge-base-role`
    - Click <b>Next</b>
7. Configure query engine
    - Query engine connection details: select <b>Redshift serverless</b> and for <b>Workgroup</b> choose `bedrock-kb`
    - Authentication: select <b>Secrets manager</b> and under <b>Select secret ARN</b> choose the same secret from step 2 above.
    - Storage configuration: select <b>Amazon Redshift databases</b> and under <b>Redshift database list</b> choose `eligibility` from the dropdown list.
    - Click <b>Next</b>
8. Review and create
    - Ensure the details are correct and click `Create Knowledge Base`
9. Once the Knowledge Base is created, from the overview page, scroll to the Query engine section and click <b>Sync</b>.
10. Wait until the Query engine status shows <b>COMPLETE</b>, then proceed to the next section.

### Associate Knowledge Base with Agent
11. Go to <b>Amazon Bedrock</b> -> <b>Agents</b>
12. Click on `eligibility-agent` and click <b>Edit in Agent Builder</b>
13. Scroll to <b>Knowledge Bases</b> and click <b>Add</b>
14. Select the Knowledge Base created in the previous section.
15. Provide instructions, i.e. `You can query the knowledge base to find out a user's eligibility information.`
16. Click <b>Add</b> then <b>Save</b> then <b>Prepare</b>
17. In the Test Agent window:
    - Ask about `test-user-123` - you should receive a response indicating the agent has access to the database (e.g. <em>Test-user-123 is eligible for free school meals.</em>)
    - Ask about `test-user-456` - you should receive a response indicating no information was found for this user.

<b>IMPORTANT:</b> Any data added to the Redshift database will not be available to the agent until the Knowledge Base is synced again. After inserting or updating data, return to the Knowledge Base overview page and click <b>Sync</b>.


